<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>💖 Nuestra Página del Amor - Laberinto Avanzado 💖</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,500;0,600;1,400;1,500&family=Great+Vibes&family=Cinzel:wght@400;500;600&family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;1,400;1,500&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Comic Sans MS', cursive; 
            background: linear-gradient(135deg, #d8bfd8 0%, #dda0dd 100%); 
            min-height: 100vh; color: #333; 
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header { text-align: center; margin-bottom: 30px; }
        h1 { 
            font-size: 2.5em; color: #8b008b; 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1); margin-bottom: 10px; 
        }
        .nav-buttons { 
            display: flex; flex-wrap: wrap; gap: 15px; 
            justify-content: center; margin-bottom: 30px; 
        }
        .nav-btn { 
            background: linear-gradient(45deg, #9370db, #8b008b); 
            color: white; border: none; padding: 15px 25px; 
            border-radius: 25px; font-size: 16px; cursor: pointer; 
            transition: all 0.3s; box-shadow: 0 5px 15px rgba(0,0,0,0.2); 
        }
        .nav-btn:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 8px 25px rgba(0,0,0,0.3); 
        }
        .nav-btn.active { 
            background: linear-gradient(45deg, #9932cc, #8b008b); 
            transform: scale(1.05); 
        }
        .content-section { 
            display: none; background: rgba(255,255,255,0.95); 
            padding: 40px; border-radius: 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-bottom: 20px; 
        }
        .content-section.active { display: block; }
        .section-title { 
            color: #8b008b; font-size: 2em; text-align: center; 
            margin-bottom: 30px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); 
        }
        
        /* Estilos del laberinto mejorado */
        .maze-game { text-align: center; }
        .maze-canvas { 
            border: none; 
            background: transparent;
        }
        .character-container { 
            position: absolute; z-index: 10; pointer-events: none;
            width: 48px; height: 48px; 
        }
        .character-container { 
            position: absolute; z-index: 10; pointer-events: none;
            width: 48px; height: 48px; 
        }
        .character-sprite { 
            width: 100%; height: 100%; 
            position: relative;
            transition: transform 0.2s ease;
            border-radius: 50%;
            overflow: hidden;
            /* Hacer el contenedor más pequeño para reducir área negra */
            transform: scale(0.85);
            /* Agregar máscara circular para ocultar completamente los bordes negros */
            -webkit-mask: radial-gradient(circle, white 70%, transparent 72%);
            mask: radial-gradient(circle, white 70%, transparent 72%);
            /* Sombra sutil para darle profundidad */
            box-shadow: 0 2px 8px rgba(255, 105, 180, 0.3);
        }
        .character-sprite iframe {
            width: 140%; height: 140%;
            position: absolute;
            top: -20%; left: -20%;
            border: none;
            /* Hacer zoom para que Kirby ocupe más espacio y se vea menos negro */
            transform: scale(1.2);
            border-radius: 50%;
            /* Filtros para mejorar la apariencia */
            filter: contrast(1.1) brightness(1.05);
            /* Recortar más el área negra */
            clip-path: circle(45% at 50% 50%);
        }
        .character-happy { 
            animation: characterHappy 0.8s ease-in-out; 
        }
        @keyframes characterHappy { 
            0%, 100% { transform: scale(0.85) rotate(0deg); } 
            25% { transform: scale(0.95) rotate(-8deg); } 
            50% { transform: scale(1.0) rotate(0deg); }
            75% { transform: scale(0.95) rotate(8deg); } 
        }
        
        .control-btn { 
            background: #9370db; color: white; border: none; 
            padding: 12px 16px; margin: 5px; border-radius: 10px; 
            font-size: 18px; cursor: pointer; transition: all 0.3s; 
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }
        .control-btn:hover { 
            background: #8b008b; transform: translateY(-2px); 
            box-shadow: 0 5px 12px rgba(0,0,0,0.3);
        }
        .control-btn:active { 
            transform: scale(0.95); 
        }
        
        /* Estilos para carta antigua con textura */
        .carta-text {
            font-family: 'Cormorant Garamond', 'Playfair Display', serif;
            font-size: 18px;
            line-height: 1.9;
            color: #3a2317;
            /* Textura de pergamino antiguo */
            background: 
                radial-gradient(circle at 20% 30%, rgba(139, 69, 19, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(101, 67, 33, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(160, 82, 45, 0.06) 0%, transparent 50%),
                linear-gradient(45deg, #f4f1e8 0%, #ede4d1 100%);
            padding: 50px;
            border-radius: 20px;
            box-shadow: 
                0 0 30px rgba(139, 69, 19, 0.2),
                inset 0 0 50px rgba(139, 69, 19, 0.05);
            border: 4px double #8b4513;
            position: relative;
            margin: 30px 0;
            /* Efecto de papel viejo */
            background-size: 200px 200px, 150px 150px, 100px 100px, 100% 100%;
        }
        .carta-text::before {
            content: '';
            position: absolute;
            top: -8px; left: -8px; right: -8px; bottom: -8px;
            border: 2px solid #d4af37;
            border-radius: 25px;
            z-index: -1;
            background: 
                radial-gradient(circle at 10% 10%, rgba(212, 175, 55, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 90% 90%, rgba(212, 175, 55, 0.1) 0%, transparent 50%);
        }
        .carta-text::after {
            content: '';
            position: absolute;
            top: 20px; left: 20px; right: 20px; bottom: 20px;
            border: 1px solid rgba(139, 69, 19, 0.2);
            border-radius: 15px;
            z-index: -1;
            pointer-events: none;
        }
        .carta-greeting {
            font-family: 'Great Vibes', cursive;
            font-size: 32px;
            color: #8b0000;
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 1px 1px 2px rgba(139, 69, 19, 0.3);
            opacity: 0;
            animation: fadeIn 1s ease-in-out 0.5s forwards;
        }
        .carta-body {
            text-align: justify;
            margin-bottom: 30px;
            font-weight: 400;
            text-shadow: 0.5px 0.5px 1px rgba(139, 69, 19, 0.1);
            min-height: 200px;
        }
        .carta-signature {
            font-family: 'Dancing Script', cursive;
            font-size: 26px;
            color: #8b0000;
            text-align: right;
            margin-top: 40px;
            text-shadow: 1px 1px 2px rgba(139, 69, 19, 0.3);
            opacity: 0;
        }
        
        /* Efecto typewriter para la carta */
        .typewriter {
            border-right: 2px solid #8b0000;
            animation: blink 1s infinite;
        }
        .typewriter.finished {
            border-right: none;
        }
        
        @keyframes blink {
            0%, 50% { border-color: #8b0000; }
            51%, 100% { border-color: transparent; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Estilos para Bubu y animación de corazones */
        .bubu-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            width: 120px;
            height: 120px;
        }
        
        /* Estilos específicos para la sección de disparos */
        .bubu-disparos-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 150px;
            height: 150px;
            z-index: 10;
            animation: bubuBounce 2s ease-in-out infinite;
        }
        
        @keyframes bubuBounce {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) translateY(-10px) scale(1.05); }
        }

        /* Estilos para Corazón 3D */
        .corazon3d-container {
            position: relative;
            width: 100%;
            height: 500px;
            border-radius: 20px;
            overflow: hidden;
            background: linear-gradient(135deg, #2d1b69, #8b008b, #9370db);
            box-shadow: 0 10px 30px rgba(139, 0, 139, 0.4);
            margin: 20px 0;
        }

        /* Estilos para Corazón de Partículas */
        .corazon-particulas-container {
            position: relative;
            width: 100%;
            height: 600px;
            border-radius: 20px;
            overflow: hidden;
            background: #000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            margin: 20px 0;
        }

        #corazon-particulas-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important;
            display: block;
            border-radius: 20px;
            z-index: 1;
        }

        #corazon-particulas-controls-container {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
        }

        #corazon-particulas-toggle-controls {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 10px;
            backdrop-filter: blur(5px);
            font-family: inherit;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        #corazon-particulas-toggle-controls:hover {
            background: rgba(139, 0, 139, 0.8);
            transform: translateY(-2px);
        }

        #corazon-particulas-controls {
            background: rgba(100, 100, 100, 0.15);
            padding: 20px;
            border-radius: 15px;
            max-width: 320px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: block;
        }

        .corazon-particulas-control-group {
            margin: 15px 0;
            display: flex;
            align-items: center;
            color: white;
        }

        .corazon-particulas-control-group label {
            width: 110px;
            font-size: 14px;
            margin-right: 10px;
            font-weight: 500;
        }

        .corazon-particulas-control-group input[type="range"] {
            flex-grow: 1;
            margin-right: 10px;
            accent-color: #8b008b;
        }

        .corazon-particulas-control-group span {
            width: 35px;
            text-align: right;
            font-size: 14px;
            font-weight: bold;
            color: #dda0dd;
        }

        .corazon-particulas-control-group select {
            flex-grow: 1;
            padding: 8px;
            border-radius: 6px;
            background: rgba(51, 51, 51, 0.8);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-family: inherit;
        }

        #corazon-particulas-toggle-fullscreen {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            z-index: 100;
            backdrop-filter: blur(5px);
            font-family: inherit;
            transition: all 0.3s ease;
        }

        #corazon-particulas-toggle-fullscreen:hover {
            background: rgba(139, 0, 139, 0.8);
            transform: translateY(-2px);
        }

        .corazon-particulas-controls-bottom {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            gap: 15px;
        }

        .corazon-particulas-btn {
            background: linear-gradient(135deg, #8b008b, #9370db);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-family: inherit;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(139, 0, 139, 0.4);
        }

        .corazon-particulas-btn:hover {
            background: linear-gradient(135deg, #9370db, #dda0dd);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(139, 0, 139, 0.6);
        }

        .corazon-particulas-info {
            background: rgba(139, 0, 139, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }

        .corazon-particulas-info p {
            color: #8b008b;
            font-size: 16px;
            margin: 8px 0;
            font-weight: 500;
        }

        @media (max-width: 600px) {
            #corazon-particulas-controls-container {
                top: 10px;
                left: 10px;
                right: 10px;
                max-width: none;
            }

            .corazon-particulas-control-group label {
                width: 80px;
                font-size: 12px;
            }

            .corazon-particulas-controls-bottom {
                bottom: 10px;
                flex-direction: column;
                align-items: center;
            }
        }

        #corazon3d-canvas {
            width: 100% !important;
            height: 100% !important;
            display: block;
            border-radius: 20px;
            background: transparent;
            min-height: 500px;
        }

        .corazon3d-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            gap: 15px;
        }

        .corazon3d-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .corazon3d-btn.start-btn {
            background: linear-gradient(45deg, #ff69b4, #ff1493);
            color: white;
        }

        .corazon3d-btn.start-btn:hover {
            background: linear-gradient(45deg, #ff1493, #dc143c);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 20, 147, 0.4);
        }

        .corazon3d-btn.stop-btn {
            background: linear-gradient(45deg, #ff4444, #cc0000);
            color: white;
        }

        .corazon3d-btn.stop-btn:hover {
            background: linear-gradient(45deg, #cc0000, #990000);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 68, 68, 0.4);
        }

        .corazon3d-info {
            margin-top: 20px;
            padding: 20px;
            background: rgba(147, 112, 219, 0.1);
            border-radius: 15px;
            border: 2px solid rgba(139, 0, 139, 0.2);
        }

        .corazon3d-info p {
            margin: 8px 0;
            color: #8b008b;
            font-weight: bold;
            font-size: 14px;
        }
        
        .disparos-hearts-area {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }
        
        .disparos-floating-heart {
            position: absolute;
            font-size: 24px;
            color: #8b008b;
            pointer-events: none;
            text-shadow: 0 0 15px rgba(139, 0, 139, 0.7);
            animation: disparosFloatToFormation 2.5s ease-out forwards;
            z-index: 6;
        }
        
        @keyframes disparosFloatToFormation {
            0% {
                opacity: 1;
                transform: scale(0.8) rotate(0deg);
            }
            20% {
                opacity: 1;
                transform: scale(1) rotate(45deg);
            }
            80% {
                opacity: 1;
                transform: scale(1) rotate(315deg);
            }
            100% {
                opacity: 1;
                transform: scale(1) rotate(360deg);
            }
        }
        
        .disparos-heart-formation {
            position: absolute;
            top: 50%;
            right: 80px;
            transform: translateY(-50%);
            width: 250px;
            height: 250px;
            z-index: 7;
            pointer-events: none;
        }
        
        .disparos-formed-heart {
            position: absolute;
            font-size: 18px;
            color: #8b008b;
            text-shadow: 0 0 12px rgba(139, 0, 139, 0.8);
            animation: disparosHeartPulse 2.5s ease-in-out infinite;
        }
        
        @keyframes disparosHeartPulse {
            0%, 100% {
                transform: scale(1);
                opacity: 0.9;
                filter: brightness(1);
            }
            50% {
                transform: scale(1.3);
                opacity: 1;
                filter: brightness(1.2);
            }
        }
        
        @keyframes disparosHeartFormation {
            0% {
                opacity: 0;
                transform: scale(0) rotate(-180deg);
            }
            50% {
                opacity: 1;
                transform: scale(1.4) rotate(0deg);
            }
            100% {
                opacity: 1;
                transform: scale(1) rotate(180deg);
            }
        }
        
        .hearts-animation-area {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 999;
            overflow: hidden;
        }
        
        .floating-heart {
            position: absolute;
            font-size: 20px;
            color: #ff1744;
            animation: floatUp 4s ease-out forwards;
            opacity: 0;
            pointer-events: none;
            text-shadow: 0 0 10px rgba(255, 23, 68, 0.5);
        }
        
        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0) scale(0.8) rotate(0deg);
            }
            50% {
                opacity: 0.8;
                transform: translateY(-200px) scale(1) rotate(180deg);
            }
            100% {
                opacity: 0;
                transform: translateY(-400px) scale(0.6) rotate(360deg);
            }
        }
        
        .heart-formation {
            position: fixed;
            top: 50%;
            right: 100px;
            transform: translateY(-50%);
            width: 200px;
            height: 200px;
            z-index: 998;
            pointer-events: none;
        }
        
        .formed-heart {
            position: absolute;
            font-size: 16px;
            color: #ff1744;
            animation: heartPulse 2s ease-in-out infinite;
            text-shadow: 0 0 8px rgba(255, 23, 68, 0.6);
        }
        
        @keyframes heartPulse {
            0%, 100% {
                transform: scale(1);
                opacity: 0.8;
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
            }
        }
        
        @keyframes heartFormation {
            0% {
                opacity: 0;
                transform: scale(0) rotate(0deg);
            }
            50% {
                opacity: 1;
                transform: scale(1.2) rotate(180deg);
            }
            100% {
                opacity: 1;
                transform: scale(1) rotate(360deg);
            }
        }
        
        /* Otros estilos necesarios */
        .upload-area { 
            background: #fce4ec; border: 3px dashed #ff69b4; border-radius: 15px; 
            padding: 40px; margin: 20px 0; cursor: pointer; transition: all 0.3s; 
        }
        .upload-area:hover { background: #f8bbd9; border-color: #e91e63; }
        .upload-input { display: none; }
        .photo-viewer { 
            margin: 30px 0; min-height: 300px; background: #fce4ec; 
            border-radius: 15px; padding: 20px; display: flex; 
            align-items: center; justify-content: center; 
        }
        .photo-viewer img { 
            max-width: 100%; max-height: 400px; border-radius: 10px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); 
        }
        .emotion-cards { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 20px; margin: 30px 0; 
        }
        .emotion-card { 
            background: linear-gradient(45deg, #fff, #fce4ec); 
            padding: 30px 20px; border-radius: 15px; text-align: center; 
            cursor: pointer; transition: all 0.3s; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
        }
        .emotion-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); 
        }
        
        @media (max-width: 768px) {
            .nav-buttons { flex-direction: column; align-items: center; }
            .control-btn { padding: 10px 14px; font-size: 16px; }
            h1 { font-size: 2em; }
            .carta-text { padding: 25px; font-size: 16px; }
        }
    </style>
    
    <!-- Three.js y Ammo.js exactos como solicitaste -->
    <script type="importmap">
    {
        "imports": {      
            "three": "https://unpkg.com/three@0.177.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.177.0/examples/jsm/"
        }
    }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.4.2/chroma.min.js"></script>
    <script src="https://cdn.babylonjs.com/ammo.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>💖 Nuestra Página del Amor 💖</h1>
            <p style="font-size: 1.2em; color: #666;">Un lugar especial para nosotros</p>
        </header>

        <nav class="nav-buttons">
            <button class="nav-btn active" onclick="showSection('laberinto')">🌟 Laberinto del Amor</button>
            <button class="nav-btn" onclick="showSection('disparos')">💥 Disparos de Corazones</button>
            <button class="nav-btn" onclick="showSection('corazon3d')">🌟 Corazón 3D</button>
            <button class="nav-btn" onclick="showSection('corazon-particulas')">✨ Partículas</button>
            <button class="nav-btn" onclick="showSection('carta')">💌 Carta de Amor</button>
            <button class="nav-btn" onclick="showSection('fotos')">📸 Nuestras Fotos</button>
            <button class="nav-btn" onclick="showSection('emociones')">💭 Mis Emociones</button>
        </nav>

        <!-- Sección Laberinto Avanzado -->
        <section id="laberinto" class="content-section active">
            <h2 class="section-title">🌟 Laberinto del Amor Avanzado</h2>
            <div class="maze-game">
                <p style="font-size: 18px; margin: 20px 0;">¡Explora el gran laberinto y encuentra todos los corazones! La cámara te seguirá en tu aventura 💖</p>
                <div style="position: relative; display: inline-block; border: 3px solid #ff69b4; border-radius: 10px; overflow: hidden; background: #000;">
                    <canvas id="mazeCanvas" class="maze-canvas" width="700" height="500"></canvas>
                    <div id="characterContainer" class="character-container">
                        <div id="characterSprite" class="character-sprite">
                            <iframe src="https://gifer.com/embed/Y3il" frameBorder="20" allowFullScreen></iframe>
                        </div>
                    </div>
                </div>
                
                <div style="margin: 20px 0;">
                    <p id="kirbyMessage" style="font-size: 18px; margin: 15px 0; color: #ff1744; font-weight: bold; text-align: center; background: rgba(255,255,255,0.9); padding: 10px 20px; border-radius: 15px; box-shadow: 0 3px 10px rgba(255,23,68,0.3); transition: all 0.3s ease; min-height: 50px; display: flex; align-items: center; justify-content: center;">🌸 ¡Kirby está listo para la aventura! 🌸</p>
                    <div style="margin: 15px 0; display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
                        <button class="control-btn" onclick="moveKirby('up')">⬆️ Arriba</button>
                    </div>
                    <div style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                        <button class="control-btn" onclick="moveKirby('left')">⬅️ Izq</button>
                        <button class="control-btn" onclick="moveKirby('down')">⬇️ Abajo</button>
                        <button class="control-btn" onclick="moveKirby('right')">➡️ Der</button>
                    </div>
                    <div style="margin: 15px 0;">
                        <button class="control-btn" onclick="resetGame()" style="background: #28a745;">🔄 Nuevo Juego</button>
                    </div>
                </div>
                
                <div style="background: rgba(255,255,255,0.9); padding: 15px; border-radius: 10px; margin: 20px auto; max-width: 500px;">
                    <h4 style="color: #ff1744; margin-bottom: 10px;">📊 Estadísticas del Juego</h4>
                    <div style="display: flex; justify-content: space-between; font-size: 16px;">
                        <span>💖 Corazones: <span id="hearts" style="color: #ff1744; font-weight: bold;">0/8</span></span>
                        <span>👣 Pasos: <span id="steps" style="color: #ff1744; font-weight: bold;">0</span></span>
                        <span>⏰ Tiempo: <span id="time" style="color: #ff1744; font-weight: bold;">00:00</span></span>
                    </div>
                </div>
                
                <div style="margin: 20px 0; font-size: 14px; color: #666;">
                    <p><strong>💡 Instrucciones:</strong></p>
                    <p>• Usa las flechas del teclado o los botones para moverte</p>
                    <p>• La cámara te seguirá automáticamente</p>
                    <p>• Encuentra todos los 8 corazones 💖</p>
                    <p>• Mira el mini-mapa en la esquina superior derecha</p>
                </div>
            </div>
        </section>

        <!-- Sección Corazón 3D -->
        <section id="corazon3d" class="content-section">
            <h2 class="section-title">🌟 Corazón 3D con Física</h2>
            <div style="text-align: center; margin: 30px 0;">
                <p style="font-size: 18px; color: #8b008b; margin-bottom: 20px;">
                    ¡Experimenta corazones 3D flotando con física realista! 💜✨
                </p>
                <p style="font-size: 16px; color: #666; margin-bottom: 30px;">
                    Usa el mouse para rotar la vista y observa cómo los corazones caen y rebotan
                </p>
            </div>
                
            <div class="corazon3d-container">
                <canvas id="corazon3d-canvas"></canvas>
                <div class="corazon3d-controls">
                    <button id="corazon3d-start" class="corazon3d-btn start-btn">🚀 Iniciar Corazones 3D</button>
                    <button id="corazon3d-stop" class="corazon3d-btn stop-btn" style="display: none;">⏹️ Detener Física</button>
                </div>
            </div>
                
            <div class="corazon3d-info">
                <p>🌟 Usa el mouse para rotar la vista</p>
                <p>🎯 Los corazones caen por gravedad y rebotan</p>
                <p>💫 Física 3D realista con Three.js y Ammo.js</p>
            </div>
        </section>

        <!-- Sección Corazón de Partículas -->
        <section id="corazon-particulas" class="content-section">
            <h2 class="section-title">✨ Corazón de Partículas Interactivas ✨</h2>
            <div style="text-align: center; margin: 30px 0;">
                <p style="font-size: 18px; color: #8b008b; margin-bottom: 20px;">
                    ¡Disfruta de un hermoso corazón formado por partículas dinámicas! 💜✨
                </p>
                <p style="font-size: 16px; color: #666; margin-bottom: 30px;">
                    Mueve el mouse para interactuar con las partículas y personaliza los efectos
                </p>
            </div>

            <div class="corazon-particulas-container">
                <div id="corazon-particulas-controls-container">
                    <button id="corazon-particulas-toggle-controls">Controles</button>
                    <button id="corazon-particulas-toggle-fullscreen">Pantalla Completa</button>
                    <div id="corazon-particulas-controls">
                        <div class="corazon-particulas-control-group">
                            <label for="corazon-particulas-colorScheme">Colores:</label>
                            <select id="corazon-particulas-colorScheme">
                                <option value="rainbow">Arcoíris</option>
                                <option value="red">Rojo</option>
                                <option value="green">Verde</option>
                                <option value="blue">Azul</option>
                                <option value="monochrome">Monocromático</option>
                            </select>
                        </div>
                        <div class="corazon-particulas-control-group">
                            <label for="corazon-particulas-particleSize">Tamaño:</label>
                            <input type="range" id="corazon-particulas-particleSize" min="1" max="20" value="10">
                            <span id="corazon-particulas-particleSizeValue">10</span>
                        </div>
                        <div class="corazon-particulas-control-group">
                            <label for="corazon-particulas-particleCount">Partículas:</label>
                            <input type="range" id="corazon-particulas-particleCount" min="10" max="100" value="32">
                            <span id="corazon-particulas-particleCountValue">32</span>
                        </div>
                        <div class="corazon-particulas-control-group">
                            <label for="corazon-particulas-speed">Velocidad:</label>
                            <input type="range" id="corazon-particulas-speed" min="0.1" max="2" step="0.1" value="1">
                            <span id="corazon-particulas-speedValue">1</span>
                        </div>
                        <div class="corazon-particulas-control-group">
                            <label for="corazon-particulas-mouseInfluence">Seguir Mouse:</label>
                            <input type="range" id="corazon-particulas-mouseInfluence" min="0" max="100" value="50">
                            <span id="corazon-particulas-mouseInfluenceValue">50</span>
                        </div>
                    </div>
                </div>

                <canvas id="corazon-particulas-canvas"></canvas>
                
                <div class="corazon-particulas-controls-bottom">
                    <button id="corazon-particulas-start" class="corazon-particulas-btn start-btn">🎆 Iniciar Partículas</button>
                    <button id="corazon-particulas-stop" class="corazon-particulas-btn stop-btn" style="display: none;">⏹️ Detener Partículas</button>
                </div>
            </div>
                
            <div class="corazon-particulas-info">
                <p>🎨 Cambia los colores y efectos con los controles</p>
                <p>🖱️ Mueve el mouse sobre el corazón para interactuar</p>
                <p>✨ Partículas dinámicas que siguen la forma del corazón</p>
            </div>
        </section>

        <!-- Sección Disparos de Corazones -->
        <section id="disparos" class="content-section">
            <h2 class="section-title">💥 Disparos de Corazones con Bubu</h2>
            <div style="text-align: center; margin: 30px 0;">
                <p style="font-size: 18px; color: #8b008b; margin-bottom: 20px;">
                    ¡Bubu está disparando corazones de amor solo para ti! 💖✨
                </p>
                <p style="font-size: 16px; color: #666; margin-bottom: 30px;">
                    Observa cómo los corazones salen volando y forman un gran corazón de amor en el aire
                </p>
            </div>
            
            <!-- Área de la animación de disparos -->
            <div style="position: relative; min-height: 500px; background: linear-gradient(135deg, #e6e6fa 0%, #dda0dd 100%); border-radius: 20px; overflow: hidden; margin: 20px 0;">
                
                <!-- Área donde aparecerán los corazones flotantes -->
                <div class="disparos-hearts-area" id="disparosHeartsArea"></div>
                
                <!-- Área donde se formará el corazón grande -->
                <div class="disparos-heart-formation" id="disparosHeartFormation"></div>
                
                <!-- Personaje Bubu en el centro-izquierda -->
                <div class="bubu-disparos-container">
                    <div class="tenor-gif-embed" data-postid="12821460386313162042" data-share-method="host" data-aspect-ratio="1" data-width="100%">
                        <a href="https://tenor.com/view/bubu-cute-bubu-gun-bubu-attack-bubu-bubu-angry-gif-12821460386313162042">Bubu Cute Bubu Gun Sticker</a>
                        from <a href="https://tenor.com/search/bubu+cute-stickers">Bubu Cute Stickers</a>
                    </div>
                </div>
                
                <!-- Mensajes románticos -->
                <div style="position: absolute; bottom: 20px; left: 20px; right: 20px; text-align: center;">
                    <p id="disparosMessage" style="font-size: 16px; color: #8b008b; font-weight: bold; background: rgba(255,255,255,0.9); padding: 10px; border-radius: 10px;">
                        💖 Bubu está cargando amor para ti... 💖
                    </p>
                </div>
            </div>
            
            <!-- Controles de la animación -->
            <div style="text-align: center; margin: 20px 0;">
                <button class="control-btn" onclick="startDisparosAnimation()" style="background: #28a745; margin: 5px;">
                    🚀 Comenzar Disparos
                </button>
                <button class="control-btn" onclick="pauseDisparosAnimation()" style="background: #ffc107; margin: 5px;">
                    ⏸️ Pausar
                </button>
                <button class="control-btn" onclick="resetDisparosAnimation()" style="background: #dc3545; margin: 5px;">
                    🔄 Reiniciar
                </button>
            </div>
            
            <div style="background: rgba(255,255,255,0.9); padding: 20px; border-radius: 15px; margin: 20px 0; text-align: center;">
                <h4 style="color: #8b008b; margin-bottom: 15px;">💕 Información de los Disparos</h4>
                <div style="display: flex; justify-content: space-around; flex-wrap: wrap; font-size: 16px;">
                    <span>💖 Corazones Disparados: <span id="heartsFired" style="color: #8b008b; font-weight: bold;">0</span></span>
                    <span>🎯 Corazones en Formación: <span id="heartsInFormation" style="color: #8b008b; font-weight: bold;">0</span></span>
                    <span>⏱️ Tiempo Activo: <span id="disparosTime" style="color: #8b008b; font-weight: bold;">00:00</span></span>
                </div>
            </div>
        </section>

        <!-- Sección Carta -->
        <section id="carta" class="content-section">
            <h2 class="section-title">💌 Carta de Amor</h2>
            <div class="carta-text">
                <div class="carta-greeting">Mi Amor Hermosa</div>
                <div class="carta-body">
                    <!-- El contenido se escribirá automáticamente con efecto typewriter -->
                </div>
                <div class="carta-signature">Con todo mi amor eterno, ❤️<br>Tu persona especial</div>
            </div>
        </section>

        <!-- Sección Fotos -->
        <section id="fotos" class="content-section">
            <h2 class="section-title">📸 Nuestras Fotos Especiales</h2>
            <div class="upload-area" onclick="document.getElementById('photoUpload').click()">
                <input type="file" id="photoUpload" class="upload-input" multiple accept="image/*">
                <h3 style="color: #ff69b4; margin-bottom: 15px;">📁 Subir Nuestras Fotos</h3>
                <p>Haz clic aquí para subir las fotos de nuestros momentos especiales</p>
                <p style="font-size: 14px; color: #999; margin-top: 10px;">Acepta múltiples imágenes: JPG, PNG, etc.</p>
            </div>
            <div class="photo-viewer" id="photoViewer">
                <p style="color: #999;">Las fotos aparecerán aquí ✨</p>
            </div>
            <div style="text-align: center; margin: 20px 0;">
                <button id="prevPhoto" class="control-btn" style="display: none;">⬅️ Anterior</button>
                <span id="photoCounter" style="margin: 0 20px; font-weight: bold;"></span>
                <button id="nextPhoto" class="control-btn" style="display: none;">➡️ Siguiente</button>
            </div>
        </section>

        <!-- Sección Emociones -->
        <section id="emociones" class="content-section">
            <h2 class="section-title">💭 Expresa Tus Emociones</h2>
            <p style="text-align: center; font-size: 18px; margin-bottom: 30px;">¿Cómo te sientes hoy? Elige una opción:</p>
            <div class="emotion-cards">
                <div class="emotion-card feliz" onclick="showEmotionalCard('feliz')">
                    <div style="font-size: 48px; margin-bottom: 15px;">😊</div>
                    <h3>Estoy Feliz</h3>
                    <p>Para días llenos de alegría</p>
                </div>
                <div class="emotion-card romantica" onclick="showEmotionalCard('romantica')">
                    <div style="font-size: 48px; margin-bottom: 15px;">💖</div>
                    <h3>Estoy Romántica</h3>
                    <p>Para momentos de amor</p>
                </div>
                <div class="emotion-card nostalgica" onclick="showEmotionalCard('nostalgica')">
                    <div style="font-size: 48px; margin-bottom: 15px;">🌙</div>
                    <h3>Estoy Nostálgica</h3>
                    <p>Para recordar momentos</p>
                </div>
                <div class="emotion-card motivacional" onclick="showEmotionalCard('motivacional')">
                    <div style="font-size: 48px; margin-bottom: 15px;">💪</div>
                    <h3>Necesito Motivación</h3>
                    <p>Para días difíciles</p>
                </div>
            </div>
        </section>
    </div>

    <script type="text/javascript" async src="https://tenor.com/embed.js"></script>

    <script>
        let gameData = {
            kirbyX: 1, kirbyY: 1, hearts: 0, steps: 0, time: 0, timer: null,
            maze: null, canvas: null, ctx: null, cellSize: 35,
            heartPositions: [], collectedHearts: [],
            camera: { x: 0, y: 0 },
            mazeWidth: 35, mazeHeight: 25,
            viewportWidth: 700, viewportHeight: 500,
            totalHearts: 8
        };
        let photoGallery = { photos: [], currentIndex: 0 };
        let heartAnimationData = {
            isActive: false,
            heartFormation: [],
            formationComplete: false,
            heartInterval: null,
            formationTimer: null
        };
        
        let disparosData = {
            isActive: false,
            heartsFired: 0,
            heartsInFormation: 0,
            time: 0,
            timer: null,
            shootInterval: null,
            formationInterval: null,
            heartFormation: [],
            loveParticles: [], // Array para las partículas de amor
            animationId: null,
            continuousFireId: null, // Para el disparo continuo
            messages: [
                "💖 ¡Bubu te está disparando amor puro! 💖",
                "🌹 ¡Cada corazón lleva mis sentimientos! 🌹",
                "✨ ¡Los disparos de amor son infinitos! ✨",
                "💕 ¡Bubu nunca se queda sin munición romántica! 💕",
                "🎯 ¡Todos los disparos van directo a tu corazón! 🎯",
                "💫 ¡El amor de Bubu es imparable! 💫",
                "🌟 ¡Cada corazón es una promesa de amor eterno! 🌟"
            ]
        };

        document.addEventListener('DOMContentLoaded', function() {
            console.log('💖 Página cargada - Con Disparos de Corazones');
            initAllSections();
        });

        function initAllSections() { 
            initCarta(); 
            initGallery(); 
            initMaze(); 
        }

        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');
            
            if (sectionId === 'laberinto') {
                setTimeout(() => {
                    initMaze();
                    startGameLoop();
                }, 100);
            } else if (sectionId === 'disparos') {
                // Detener otras animaciones
                stopAllAnimations();
                setTimeout(() => {
                    initDisparosSection();
                }, 200);
            } else if (sectionId === 'carta') {
                // Reiniciar la carta si ya se había mostrado
                const cartaBody = document.querySelector('.carta-body');
                const cartaSignature = document.querySelector('.carta-signature');
                if (cartaBody && cartaBody.innerHTML.trim() !== '') {
                    cartaBody.innerHTML = '';
                    cartaSignature.style.opacity = '0';
                }
                setTimeout(() => {
                    initTypewriterCarta();
                }, 500);
            }
        }

        function initCarta() {
            // La carta se inicializará cuando se haga click en su sección
        }
        
        function initTypewriterCarta() {
            // Texto completo de la carta
            const cartaText = `En este universo infinito de posibilidades, el destino conspiró para juntarnos y crear la historia más hermosa que jamás había soñado. Cada día a tu lado es un regalo que atesoro en lo más profundo de mi corazón.

Eres mi luz en los días grises, mi refugio en las tormentas, y mi razón para sonreír cada mañana. Tu amor ha transformado mi mundo de maneras que nunca creí posibles, llenándolo de colores que antes no podía ver.

Prometo amarte con cada fibra de mi ser, cuidar de tus sueños como si fueran míos, y construir junto a ti un futuro lleno de risas, aventuras y momentos inolvidables.

Eres y serás siempre mi persona favorita en este mundo.`;

            const cartaElement = document.querySelector('.carta-body');
            const signatureElement = document.querySelector('.carta-signature');
            
            if (cartaElement) {
                // Limpiar contenido inicial
                cartaElement.innerHTML = '';
                cartaElement.classList.add('typewriter');
                
                let i = 0;
                const speed = 45; // Velocidad de escritura (ms por carácter)
                
                function typeWriter() {
                    if (i < cartaText.length) {
                        const char = cartaText.charAt(i);
                        if (char === '\n') {
                            cartaElement.innerHTML += '<br><br>';
                        } else {
                            cartaElement.innerHTML += char;
                        }
                        i++;
                        setTimeout(typeWriter, speed);
                    } else {
                        // Terminar efecto typewriter
                        cartaElement.classList.remove('typewriter');
                        cartaElement.classList.add('finished');
                        
                        // Mostrar la firma con animación
                        setTimeout(() => {
                            if (signatureElement) {
                                signatureElement.style.animation = 'fadeIn 2s ease-in-out forwards';
                                signatureElement.style.opacity = '1';
                            }
                        }, 800);
                    }
                }
                
                typeWriter();
            }
        }

        function initGallery() {
            document.getElementById('photoUpload').onchange = function(e) {
                Array.from(e.target.files).forEach(file => {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            photoGallery.photos.push(e.target.result);
                            if (photoGallery.photos.length === 1) {
                                photoGallery.currentIndex = 0;
                                showCurrentPhoto();
                            }
                            updatePhotoControls();
                        };
                        reader.readAsDataURL(file);
                    }
                });
            };

            document.getElementById('prevPhoto').onclick = () => {
                if (photoGallery.photos.length > 0) {
                    photoGallery.currentIndex = (photoGallery.currentIndex - 1 + photoGallery.photos.length) % photoGallery.photos.length;
                    showCurrentPhoto();
                }
            };

            document.getElementById('nextPhoto').onclick = () => {
                if (photoGallery.photos.length > 0) {
                    photoGallery.currentIndex = (photoGallery.currentIndex + 1) % photoGallery.photos.length;
                    showCurrentPhoto();
                }
            };
        }

        function showCurrentPhoto() {
            if (photoGallery.photos.length > 0) {
                document.getElementById('photoViewer').innerHTML = 
                    `<img src="${photoGallery.photos[photoGallery.currentIndex]}" alt="Nuestra foto especial">`;
                updatePhotoControls();
            }
        }

        function updatePhotoControls() {
            const prevBtn = document.getElementById('prevPhoto');
            const nextBtn = document.getElementById('nextPhoto');
            const counter = document.getElementById('photoCounter');

            if (photoGallery.photos.length > 0) {
                prevBtn.style.display = 'inline-block';
                nextBtn.style.display = 'inline-block';
                counter.textContent = `${photoGallery.currentIndex + 1} / ${photoGallery.photos.length}`;
            } else {
                prevBtn.style.display = 'none';
                nextBtn.style.display = 'none';
                counter.textContent = '';
            }
        }

        function showEmotionalCard(emotion) {
            const messages = {
                'feliz': '😊 ¡Mi amor hermoso! Tu sonrisa es mi sol favorito. Cuando sonríes, todo el mundo parece más brillante. Te amo infinitamente 💖✨',
                'romantica': '💖 Mi amor eterno, eres mi verso favorito en la poesía de la vida. En este universo infinito, el destino nos juntó. Para siempre tuyo 💖🌹',
                'nostalgica': '🌙 Mi querida, los recuerdos de nuestros primeros momentos viven en nuestros corazones. Seguimos escribiendo nuestra historia 💖🌙',
                'motivacional': '💪 Mi guerrera hermosa, eres más fuerte de lo que crees. No estás sola, tienes mi apoyo incondicional. Creo en ti siempre 💖💪✨'
            };
            alert(messages[emotion] || '💖 Te amo mucho mi amor');
        }

        // SISTEMA DE LABERINTO AVANZADO CON CÁMARA

        function initMaze() {
            const canvas = document.getElementById('mazeCanvas');
            if (!canvas) return;
            
            gameData.canvas = canvas;
            gameData.ctx = canvas.getContext('2d');
            canvas.width = gameData.viewportWidth;
            canvas.height = gameData.viewportHeight;
            
            generateComplexMaze();
            resetGame();
        }
        
        function generateComplexMaze() {
            const width = gameData.mazeWidth;
            const height = gameData.mazeHeight;
            
            // Inicializar laberinto lleno de paredes
            gameData.maze = [];
            for (let y = 0; y < height; y++) {
                gameData.maze[y] = [];
                for (let x = 0; x < width; x++) {
                    gameData.maze[y][x] = 1; // 1 = pared
                }
            }
            
            // Generar laberinto usando algoritmo de backtracking
            const stack = [];
            const startX = 1, startY = 1;
            gameData.maze[startY][startX] = 0; // 0 = camino
            stack.push([startX, startY]);
            
            const directions = [[0, -2], [2, 0], [0, 2], [-2, 0]]; // arriba, derecha, abajo, izquierda
            
            while (stack.length > 0) {
                const [currentX, currentY] = stack[stack.length - 1];
                const neighbors = [];
                
                // Encontrar vecinos no visitados
                directions.forEach(([dx, dy]) => {
                    const newX = currentX + dx;
                    const newY = currentY + dy;
                    
                    if (newX > 0 && newX < width - 1 && newY > 0 && newY < height - 1) {
                        if (gameData.maze[newY][newX] === 1) {
                            neighbors.push([newX, newY, currentX + dx/2, currentY + dy/2]);
                        }
                    }
                });
                
                if (neighbors.length > 0) {
                    // Elegir vecino aleatorio
                    const [nextX, nextY, wallX, wallY] = neighbors[Math.floor(Math.random() * neighbors.length)];
                    gameData.maze[nextY][nextX] = 0; // Crear camino
                    gameData.maze[wallY][wallX] = 0; // Romper pared
                    stack.push([nextX, nextY]);
                } else {
                    stack.pop();
                }
            }
            
            // Crear algunos caminos adicionales para hacer el laberinto más interesante
            for (let i = 0; i < Math.floor((width * height) / 15); i++) {
                const x = Math.floor(Math.random() * (width - 2)) + 1;
                const y = Math.floor(Math.random() * (height - 2)) + 1;
                if (gameData.maze[y][x] === 1 && Math.random() > 0.7) {
                    gameData.maze[y][x] = 0;
                }
            }
            
            // Colocar corazones en posiciones aleatorias
            gameData.heartPositions = [];
            let heartsPlaced = 0;
            while (heartsPlaced < gameData.totalHearts) {
                const x = Math.floor(Math.random() * (width - 2)) + 1;
                const y = Math.floor(Math.random() * (height - 2)) + 1;
                
                if (gameData.maze[y][x] === 0 && (x !== 1 || y !== 1)) {
                    // Verificar que no haya otro corazón muy cerca
                    let tooClose = false;
                    for (let [hx, hy] of gameData.heartPositions) {
                        if (Math.abs(x - hx) + Math.abs(y - hy) < 3) {
                            tooClose = true;
                            break;
                        }
                    }
                    
                    if (!tooClose) {
                        gameData.heartPositions.push([x, y]);
                        heartsPlaced++;
                    }
                }
            }
        }

        function drawMaze() {
            if (!gameData.ctx) return;
            
            const ctx = gameData.ctx;
            ctx.clearRect(0, 0, gameData.canvas.width, gameData.canvas.height);
            
            // Actualizar posición de la cámara para seguir al personaje
            updateCamera();
            
            // Calcular qué celdas son visibles
            const startX = Math.max(0, Math.floor(gameData.camera.x / gameData.cellSize));
            const endX = Math.min(gameData.mazeWidth, Math.ceil((gameData.camera.x + gameData.viewportWidth) / gameData.cellSize));
            const startY = Math.max(0, Math.floor(gameData.camera.y / gameData.cellSize));
            const endY = Math.min(gameData.mazeHeight, Math.ceil((gameData.camera.y + gameData.viewportHeight) / gameData.cellSize));
            
            // Dibujar solo las celdas visibles
            for (let y = startY; y < endY; y++) {
                for (let x = startX; x < endX; x++) {
                    const screenX = x * gameData.cellSize - gameData.camera.x;
                    const screenY = y * gameData.cellSize - gameData.camera.y;
                    
                    if (gameData.maze[y][x] === 1) {
                        // Dibujar ladrillo pixelado
                        drawPixelBrick(ctx, screenX, screenY, gameData.cellSize);
                    } else {
                        // Suelo del laberinto con patrón más detallado
                        drawFloor(ctx, screenX, screenY, gameData.cellSize);
                    }
                }
            }
            
            // Dibujar corazones visibles
            ctx.fillStyle = '#ff1744';
            ctx.font = '24px Arial';
            ctx.textAlign = 'center';
            
            gameData.heartPositions.forEach(([x, y], index) => {
                if (!gameData.collectedHearts.includes(index)) {
                    const screenX = x * gameData.cellSize - gameData.camera.x + gameData.cellSize/2;
                    const screenY = y * gameData.cellSize - gameData.camera.y + gameData.cellSize/2 + 8;
                    
                    // Solo dibujar si está en pantalla
                    if (screenX > -30 && screenX < gameData.viewportWidth + 30 && 
                        screenY > -30 && screenY < gameData.viewportHeight + 30) {
                        
                        // Efecto de brillo en los corazones
                        const time = Date.now() / 500;
                        const glow = Math.sin(time + index) * 0.3 + 0.7;
                        ctx.globalAlpha = glow;
                        ctx.fillText('💖', screenX, screenY);
                        ctx.globalAlpha = 1;
                    }
                }
            });
            
            // Dibujar mini-mapa
            drawMiniMap();
        }
        
        function drawFloor(ctx, x, y, size) {
            // Base del suelo
            const gradient = ctx.createLinearGradient(x, y, x + size, y + size);
            gradient.addColorStop(0, '#e8f5e8');
            gradient.addColorStop(0.5, '#d4f1d4');
            gradient.addColorStop(1, '#c8e6c8');
            
            ctx.fillStyle = gradient;
            ctx.fillRect(x, y, size, size);
            
            // Patrón de textura
            ctx.fillStyle = '#b8ddb8';
            for (let i = 0; i < size; i += 8) {
                for (let j = 0; j < size; j += 8) {
                    if ((i + j) % 16 === 0) {
                        ctx.fillRect(x + i, y + j, 3, 3);
                    }
                }
            }
        }
        
        function updateCamera() {
            // Centrar cámara en el personaje
            const targetX = gameData.kirbyX * gameData.cellSize - gameData.viewportWidth / 2;
            const targetY = gameData.kirbyY * gameData.cellSize - gameData.viewportHeight / 2;
            
            // Suavizar movimiento de cámara
            gameData.camera.x += (targetX - gameData.camera.x) * 0.15;
            gameData.camera.y += (targetY - gameData.camera.y) * 0.15;
            
            // Limitar cámara a los bordes del laberinto
            const maxX = gameData.mazeWidth * gameData.cellSize - gameData.viewportWidth;
            const maxY = gameData.mazeHeight * gameData.cellSize - gameData.viewportHeight;
            
            gameData.camera.x = Math.max(0, Math.min(maxX, gameData.camera.x));
            gameData.camera.y = Math.max(0, Math.min(maxY, gameData.camera.y));
        }
        
        function drawMiniMap() {
            const miniSize = 120;
            const miniX = gameData.viewportWidth - miniSize - 15;
            const miniY = 15;
            const scale = miniSize / Math.max(gameData.mazeWidth, gameData.mazeHeight);
            
            // Fondo del minimapa
            gameData.ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
            gameData.ctx.fillRect(miniX - 5, miniY - 5, miniSize + 10, miniSize + 10);
            
            // Borde del minimapa
            gameData.ctx.strokeStyle = '#ff69b4';
            gameData.ctx.lineWidth = 2;
            gameData.ctx.strokeRect(miniX - 5, miniY - 5, miniSize + 10, miniSize + 10);
            
            // Dibujar laberinto en minimapa
            for (let y = 0; y < gameData.mazeHeight; y++) {
                for (let x = 0; x < gameData.mazeWidth; x++) {
                    const pixelX = miniX + x * scale;
                    const pixelY = miniY + y * scale;
                    
                    if (gameData.maze[y][x] === 1) {
                        gameData.ctx.fillStyle = '#8B4513';
                        gameData.ctx.fillRect(pixelX, pixelY, scale + 1, scale + 1);
                    } else {
                        gameData.ctx.fillStyle = '#e8f5e8';
                        gameData.ctx.fillRect(pixelX, pixelY, scale + 1, scale + 1);
                    }
                }
            }
            
            // Mostrar corazones en minimapa
            gameData.ctx.fillStyle = '#ff1744';
            gameData.heartPositions.forEach(([x, y], index) => {
                if (!gameData.collectedHearts.includes(index)) {
                    gameData.ctx.fillRect(miniX + x * scale - 1, miniY + y * scale - 1, 3, 3);
                }
            });
            
            // Mostrar posición del jugador
            gameData.ctx.fillStyle = '#00ff00';
            const playerX = miniX + gameData.kirbyX * scale - 2;
            const playerY = miniY + gameData.kirbyY * scale - 2;
            gameData.ctx.fillRect(playerX, playerY, 4, 4);
            
            // Título del minimapa
            gameData.ctx.fillStyle = 'white';
            gameData.ctx.font = '12px Arial';
            gameData.ctx.textAlign = 'center';
            gameData.ctx.fillText('Mapa', miniX + miniSize/2, miniY - 10);
        }
        
        function drawPixelBrick(ctx, x, y, size) {
            // Base del ladrillo
            const gradient = ctx.createLinearGradient(x, y, x + size, y + size);
            gradient.addColorStop(0, '#8B4513');
            gradient.addColorStop(0.3, '#A0522D');
            gradient.addColorStop(0.7, '#8B4513');
            gradient.addColorStop(1, '#654321');
            
            ctx.fillStyle = gradient;
            ctx.fillRect(x, y, size, size);
            
            // Borde del ladrillo
            ctx.strokeStyle = '#654321';
            ctx.lineWidth = 1;
            ctx.strokeRect(x, y, size, size);
            
            // Highlights para efecto 3D
            ctx.strokeStyle = '#D2691E';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(x + size - 1, y);
            ctx.moveTo(x, y);
            ctx.lineTo(x, y + size - 1);
            ctx.stroke();
            
            // Sombras para efecto 3D
            ctx.strokeStyle = '#5D4E37';
            ctx.beginPath();
            ctx.moveTo(x + size - 1, y + 1);
            ctx.lineTo(x + size - 1, y + size - 1);
            ctx.moveTo(x + 1, y + size - 1);
            ctx.lineTo(x + size - 1, y + size - 1);
            ctx.stroke();
            
            // Textura pixelada
            ctx.fillStyle = '#A0522D';
            for (let i = 2; i < size - 2; i += 4) {
                for (let j = 2; j < size - 2; j += 4) {
                    if (Math.random() > 0.7) {
                        ctx.fillRect(x + i, y + j, 2, 2);
                    }
                }
            }
        }

        function updateKirbyPosition() {
            const characterContainer = document.getElementById('characterContainer');
            if (!characterContainer || !gameData.canvas) return;
            
            // Calcular posición en pantalla relativa a la cámara
            const screenX = (gameData.kirbyX * gameData.cellSize) - gameData.camera.x + (gameData.cellSize / 2) - 24;
            const screenY = (gameData.kirbyY * gameData.cellSize) - gameData.camera.y + (gameData.cellSize / 2) - 24;
            
            characterContainer.style.left = screenX + 'px';
            characterContainer.style.top = screenY + 'px';
        }

        function resetGame() {
            gameData.kirbyX = 1; gameData.kirbyY = 1; gameData.hearts = 0;
            gameData.steps = 0; gameData.time = 0; gameData.collectedHearts = [];
            gameData.camera.x = 0; gameData.camera.y = 0;
            
            if (gameData.timer) clearInterval(gameData.timer);
            startTimer(); 
            startGameLoop();
            updateKirbyPosition(); 
            updateUI();
            updateKirbyMessage('🌸 ¡Kirby está listo para la gran aventura! 🌸');
        }
        
        function startGameLoop() {
            function gameLoop() {
                drawMaze();
                updateKirbyPosition();
                if (document.getElementById('laberinto').classList.contains('active')) {
                    requestAnimationFrame(gameLoop);
                }
            }
            gameLoop();
        }

        function startTimer() {
            gameData.timer = setInterval(() => {
                gameData.time++; 
                updateUI();
            }, 1000);
        }

        function moveKirby(direction) {
            let newX = gameData.kirbyX; 
            let newY = gameData.kirbyY;
            
            switch(direction) {
                case 'up': newY--; break;
                case 'down': newY++; break;
                case 'left': newX--; break;
                case 'right': newX++; break;
            }
            
            if (newX >= 0 && newX < gameData.mazeWidth && 
                newY >= 0 && newY < gameData.mazeHeight && 
                gameData.maze[newY][newX] === 0) {
                
                gameData.kirbyX = newX; 
                gameData.kirbyY = newY; 
                gameData.steps++;
                
                const characterSprite = document.getElementById('characterSprite');
                if (direction === 'left') characterSprite.style.transform = 'scaleX(-1)';
                else if (direction === 'right') characterSprite.style.transform = 'scaleX(1)';
                
                updateUI(); 
                checkHeartCollection();
            }
        }

        function checkHeartCollection() {
            // Frases románticas para cuando se recoge un corazón
            const frasesRomanticas = [
                '💖 "Eres mi razón de sonreír cada día" 💖',
                '🌹 "Tu amor ilumina mi mundo entero" 🌹',
                '✨ "Contigo todo es más hermoso" ✨',
                '💕 "Eres mi sueño hecho realidad" 💕',
                '🌟 "Mi corazón late solo por ti" 🌟',
                '💗 "Eres mi persona favorita en el universo" 💗',
                '🦋 "Tu sonrisa es mi lugar feliz" 🦋',
                '💫 "Juntos somos infinitos" 💫',
                '🌸 "Eres la melodía de mi corazón" 🌸',
                '💞 "Mi amor por ti crece cada día" 💞',
                '🌺 "Eres mi refugio y mi aventura" 🌺',
                '💘 "Contigo el amor es eterno" 💘'
            ];
            
            gameData.heartPositions.forEach(([x, y], index) => {
                if (gameData.kirbyX === x && gameData.kirbyY === y && !gameData.collectedHearts.includes(index)) {
                    console.log('¡Corazón recolectado!', index); // Debug
                    gameData.collectedHearts.push(index);
                    gameData.hearts++;
                    
                    const characterSprite = document.getElementById('characterSprite');
                    characterSprite.classList.add('character-happy');
                    setTimeout(() => characterSprite.classList.remove('character-happy'), 800);
                    
                    // Seleccionar una frase romántica aleatoria
                    const fraseAleatoria = frasesRomanticas[Math.floor(Math.random() * frasesRomanticas.length)];
                    console.log('Frase seleccionada:', fraseAleatoria); // Debug
                    
                    // Agregar efecto visual extra
                    const messageEl = document.getElementById('kirbyMessage');
                    if (messageEl) {
                        messageEl.style.color = '#ff1744';
                        messageEl.style.fontWeight = 'bold';
                        messageEl.style.fontSize = '18px';
                    }
                    
                    updateKirbyMessage(fraseAleatoria);
                    updateUI();
                    
                    if (gameData.hearts === gameData.totalHearts) {
                        clearInterval(gameData.timer);
                        setTimeout(() => {
                            alert(`🎉 ¡INCREÍBLE! ¡Completaste el laberinto!\n\n⏰ Tiempo: ${formatTime(gameData.time)}\n👣 Pasos: ${gameData.steps}\n💖 Corazones: ${gameData.totalHearts}/${gameData.totalHearts}\n\n¡Eres absolutamente increíble mi amor! 💖✨🏆`);
                            updateKirbyMessage('🎉 ¡Victoria total! ¡Eres la mejor! 💖✨');
                        }, 500);
                    }
                }
            });
        }

        function updateUI() {
            document.getElementById('hearts').textContent = gameData.hearts + '/' + gameData.totalHearts;
            document.getElementById('steps').textContent = gameData.steps;
            document.getElementById('time').textContent = formatTime(gameData.time);
        }

        function updateKirbyMessage(message) {
            const messageEl = document.getElementById('kirbyMessage');
            if (messageEl) {
                console.log('Mostrando mensaje:', message); // Debug
                
                // Efecto de aparición del mensaje
                messageEl.style.opacity = '0';
                messageEl.style.transform = 'scale(0.8)';
                messageEl.textContent = message;
                
                // Animar la aparición
                setTimeout(() => {
                    messageEl.style.transition = 'all 0.3s ease-out';
                    messageEl.style.opacity = '1';
                    messageEl.style.transform = 'scale(1)';
                }, 50);
                
                // Si es una frase romántica (contiene comillas), mostrar por más tiempo
                const tiempoMostrar = message.includes('"') ? 6000 : 3000;
                
                setTimeout(() => {
                    if (gameData.hearts < gameData.totalHearts) {
                        messageEl.style.transition = 'all 0.3s ease-in';
                        messageEl.style.opacity = '0.7';
                        messageEl.textContent = '🌸 Kirby está explorando el laberinto... 🌸';
                        setTimeout(() => {
                            messageEl.style.opacity = '1';
                        }, 300);
                    }
                }, tiempoMostrar);
            } else {
                console.log('No se encontró el elemento kirbyMessage'); // Debug
            }
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        document.addEventListener('keydown', function(e) {
            if (document.getElementById('laberinto').classList.contains('active')) {
                switch(e.key) {
                    case 'ArrowUp': moveKirby('up'); e.preventDefault(); break;
                    case 'ArrowDown': moveKirby('down'); e.preventDefault(); break;
                    case 'ArrowLeft': moveKirby('left'); e.preventDefault(); break;
                    case 'ArrowRight': moveKirby('right'); e.preventDefault(); break;
                    case 'r': case 'R': resetGame(); e.preventDefault(); break;
                }
            }
        });
        
        // SISTEMA DE ANIMACIÓN DE CORAZONES DE BUBU
        
        function stopAllAnimations() {
            // Detener animaciones del sistema general
            if (heartAnimationData.heartInterval) {
                clearInterval(heartAnimationData.heartInterval);
            }
            
            // Detener animaciones de disparos
            if (disparosData.shootInterval) {
                clearInterval(disparosData.shootInterval);
            }
            if (disparosData.formationInterval) {
                clearInterval(disparosData.formationInterval);
            }
            if (disparosData.timer) {
                clearInterval(disparosData.timer);
            }
        }
        
        // FUNCIONES PARA LA SECCIÓN DE DISPAROS DE CORAZONES
        
        function initDisparosSection() {
            resetDisparosAnimation();
            updateDisparosMessage("💖 ¡Bubu está listo para disparar corazones de amor! 💖");
        }
        
        function startDisparosAnimation() {
            if (disparosData.isActive) return;
            
            disparosData.isActive = true;
            disparosData.time = 0;
            
            // Iniciar timer
            disparosData.timer = setInterval(() => {
                disparosData.time++;
                updateDisparosUI();
            }, 1000);
            
            // Comenzar disparos CONTINUOS (sin pausa)
            function continuousFire() {
                if (disparosData.isActive) {
                    fireHeart(); // Dispara ráfaga de corazones
                    // Programar el siguiente disparo inmediatamente
                    disparosData.continuousFireId = setTimeout(continuousFire, 200); // Disparo cada 200ms
                }
            }
            
            // Iniciar el disparo continuo
            continuousFire();
            
            // Cambiar mensajes cada cierto tiempo
            setInterval(() => {
                if (disparosData.isActive) {
                    const randomMessage = disparosData.messages[Math.floor(Math.random() * disparosData.messages.length)];
                    updateDisparosMessage(randomMessage);
                }
            }, 3000);
            
            updateDisparosMessage("🚀 ¡Bubu comenzó a disparar corazones continuamente! 🚀");
        }
        
        function pauseDisparosAnimation() {
            disparosData.isActive = false;
            clearInterval(disparosData.shootInterval);
            clearTimeout(disparosData.continuousFireId); // Detener disparo continuo
            clearInterval(disparosData.timer);
            if (disparosData.animationId) {
                cancelAnimationFrame(disparosData.animationId);
                disparosData.animationId = null;
            }
            updateDisparosMessage("⏸️ Disparos pausados... ¡Bubu está descansando! ⏸️");
        }
        
        function resetDisparosAnimation() {
            disparosData.isActive = false;
            disparosData.heartsFired = 0;
            disparosData.heartsInFormation = 0;
            disparosData.time = 0;
            
            clearInterval(disparosData.shootInterval);
            clearTimeout(disparosData.continuousFireId); // Detener disparo continuo
            clearInterval(disparosData.formationInterval);
            clearInterval(disparosData.timer);
            
            // Limpiar partículas de amor
            disparosData.loveParticles.forEach(p => {
                if (p.element.parentNode) {
                    p.element.parentNode.removeChild(p.element);
                }
            });
            disparosData.loveParticles = [];
            
            if (disparosData.animationId) {
                cancelAnimationFrame(disparosData.animationId);
                disparosData.animationId = null;
            }
            
            // Limpiar corazones
            const heartsArea = document.getElementById('disparosHeartsArea');
            const formationArea = document.getElementById('disparosHeartFormation');
            
            if (heartsArea) heartsArea.innerHTML = '';
            if (formationArea) formationArea.innerHTML = '';
            
            disparosData.heartFormation = [];
            updateDisparosUI();
            updateDisparosMessage("🔄 ¡Todo listo! Bubu ha recargado sus disparos de amor 🔄");
        }
        
        function fireHeart() {
            const heartsArea = document.getElementById('disparosHeartsArea');
            if (!heartsArea) return;
            
            // Crear ráfaga de 6-10 partículas de amor con física
            const burstCount = 3 + Math.floor(Math.random() * 3); // 3-5 corazones por ráfaga (continuo)
            
            for (let i = 0; i < burstCount; i++) {
                setTimeout(() => {
                    const heart = document.createElement('div');
                    heart.className = 'disparos-floating-heart';
                    heart.textContent = ['�', '�💖', '💕', '💗', '💓', '💝', '�'][Math.floor(Math.random() * 7)];
                    
                    // Posición inicial exacta en el centro (Bubu)
                    const centerX = heartsArea.clientWidth / 2;
                    const centerY = heartsArea.clientHeight / 2;
                    
                    heart.style.left = centerX + 'px';
                    heart.style.top = centerY + 'px';
                    
                    heartsArea.appendChild(heart);
                    
                    // Obtener una posición aleatoria del corazón grande para este corazón
                    const heartPoints = generateHeartPointsDisparos();
                    const targetPoint = heartPoints[Math.floor(Math.random() * heartPoints.length)];
                    
                    // Convertir a coordenadas absolutas del área de disparos
                    const formationArea = document.getElementById('disparosHeartFormation');
                    const formationRect = formationArea ? formationArea.getBoundingClientRect() : null;
                    const heartsAreaRect = heartsArea.getBoundingClientRect();
                    
                    let targetX, targetY;
                    if (formationRect) {
                        targetX = formationRect.left - heartsAreaRect.left + targetPoint.x;
                        targetY = formationRect.top - heartsAreaRect.top + targetPoint.y;
                    } else {
                        // Fallback si no encuentra el área de formación
                        targetX = heartsArea.clientWidth / 2 + targetPoint.x - 125;
                        targetY = heartsArea.clientHeight / 2 + targetPoint.y - 125;
                    }
                    
                    // Crear partícula de física para este corazón
                    const particle = {
                        element: heart,
                        x: centerX,
                        y: centerY,
                        vx: 0,
                        vy: 0,
                        targetX: targetX,
                        targetY: targetY,
                        opacity: 0.8,
                        scale: 0.8,
                        life: 0
                    };
                    
                    // Añadir a la lista de partículas activas
                    disparosData.loveParticles.push(particle);
                    
                    disparosData.heartsFired++;
                    updateDisparosUI();
                    
                }, i * 50); // Intervalo más rápido entre corazones de la ráfaga
            }
            
            // Iniciar o continuar la animación de partículas
            if (!disparosData.animationId && disparosData.isActive) {
                animateLoveParticles();
            }
        }
        
        // Función de animación de partículas de amor (como en tu ejemplo)
        function animateLoveParticles() {
            const heartsArea = document.getElementById('disparosHeartsArea');
            if (!heartsArea || !disparosData.isActive) return;
            
            // Iterar sobre todas las partículas
            disparosData.loveParticles.forEach((p, index) => {
                if (!p.element.parentNode) return;
                
                // Calcular dirección hacia el objetivo (como en tu código)
                const dx = p.targetX - p.x;
                const dy = p.targetY - p.y;
                
                // Aplicar velocidad hacia el objetivo (más rápida)
                p.vx = dx * 0.15;  // Aumenté de 0.08 a 0.15 para mayor velocidad
                p.vy = dy * 0.15;
                
                // Actualizar posición
                p.x += p.vx;
                p.y += p.vy;
                
                // Actualizar opacidad (se desvanece gradualmente)
                p.opacity = Math.min(p.opacity + 0.02, 1);
                
                // Actualizar escala con movimiento sinusoidal
                p.scale = 0.8 + 0.03 * Math.sin(Date.now() * 0.003 + p.x);
                
                // Aplicar cambios al elemento
                p.element.style.left = p.x + 'px';
                p.element.style.top = p.y + 'px';
                p.element.style.opacity = p.opacity;
                p.element.style.transform = `scale(${p.scale}) rotate(${p.life * 1.5}deg)`;
                
                // Incrementar vida
                p.life += 1;
                
                // Cuando llegan al objetivo, se quedan ahí formando el corazón
                const distance = Math.sqrt(dx * dx + dy * dy);
                if (distance < 25) {
                    // Convertir la partícula en parte de la formación
                    p.element.style.position = 'absolute';
                    p.element.style.left = p.targetX + 'px';
                    p.element.style.top = p.targetY + 'px';
                    p.element.style.transform = 'scale(1.2)';
                    p.element.className = 'disparos-formed-heart';
                    p.element.style.animation = 'disparosHeartPulse 2s ease-in-out infinite';
                    
                    // Mover al área de formación
                    const formationArea = document.getElementById('disparosHeartFormation');
                    if (formationArea) {
                        // Ajustar posición relativa a la formación
                        const heartsAreaRect = heartsArea.getBoundingClientRect();
                        const formationRect = formationArea.getBoundingClientRect();
                        const relativeX = p.targetX - (formationRect.left - heartsAreaRect.left);
                        const relativeY = p.targetY - (formationRect.top - heartsAreaRect.top);
                        
                        p.element.style.left = relativeX + 'px';
                        p.element.style.top = relativeY + 'px';
                        formationArea.appendChild(p.element);
                    }
                    
                    disparosData.heartsInFormation++;
                    updateDisparosUI();
                    
                    // Remover de la lista de partículas activas
                    disparosData.loveParticles.splice(index, 1);
                }
                
                // Remover partículas muy viejas que no llegaron
                if (p.life > 200) {
                    if (p.element.parentNode) {
                        p.element.parentNode.removeChild(p.element);
                    }
                    disparosData.loveParticles.splice(index, 1);
                }
            });
            
            // Continuar animación (ahora siempre mientras esté activo)
            if (disparosData.isActive) {
                disparosData.animationId = requestAnimationFrame(animateLoveParticles);
            } else {
                disparosData.animationId = null;
            }
        }
        
        // Crear corazón en la formación
        function createFormationHeart(x, y) {
            const formationArea = document.getElementById('disparosHeartFormation');
            if (!formationArea) return;
            
            const heart = document.createElement('div');
            heart.className = 'disparos-formed-heart';
            heart.textContent = ['💜', '💖', '💕', '💗'][Math.floor(Math.random() * 4)];
            heart.style.left = (x - formationArea.offsetLeft) + 'px';
            heart.style.top = (y - formationArea.offsetTop) + 'px';
            heart.style.animation = 'disparosHeartFormation 1.5s ease-out forwards, disparosHeartPulse 2s ease-in-out infinite';
            
            formationArea.appendChild(heart);
            disparosData.heartsInFormation++;
            updateDisparosUI();
        }
        
        function startHeartFormationDisparos() {
            const formationArea = document.getElementById('disparosHeartFormation');
            if (!formationArea) return;
            
            const heartPoints = generateHeartPointsDisparos();
            let currentIndex = 0;
            
            disparosData.formationInterval = setInterval(() => {
                if (currentIndex >= heartPoints.length || !disparosData.isActive) {
                    clearInterval(disparosData.formationInterval);
                    return;
                }
                
                const point = heartPoints[currentIndex];
                createFormedHeartDisparos(point.x, point.y, currentIndex);
                currentIndex++;
                disparosData.heartsInFormation++;
                updateDisparosUI();
            }, 300);
        }
        
        function generateHeartPointsDisparos() {
            const points = [];
            const centerX = 125;
            const centerY = 125;
            const scale = 80;
            
            // Generar puntos del contorno del corazón
            for (let t = 0; t < Math.PI * 2; t += 0.15) {
                const x = scale * (16 * Math.pow(Math.sin(t), 3));
                const y = scale * (13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t));
                
                points.push({
                    x: centerX + x / 20,
                    y: centerY - y / 20 + 30
                });
            }
            
            // Generar puntos para rellenar el interior del corazón
            const interiorPoints = 80; // Número de puntos interiores
            for (let i = 0; i < interiorPoints; i++) {
                let attempts = 0;
                let pointAdded = false;
                
                // Intentar generar un punto válido dentro del corazón
                while (attempts < 50 && !pointAdded) {
                    const randomX = (Math.random() - 0.5) * scale * 1.6; // Rango amplio
                    const randomY = (Math.random() - 0.5) * scale * 1.2; // Rango vertical
                    
                    // Verificar si el punto está dentro del corazón
                    if (isPointInsideHeart(randomX, randomY, scale)) {
                        points.push({
                            x: centerX + randomX / 20,
                            y: centerY - randomY / 20 + 30
                        });
                        pointAdded = true;
                    }
                    attempts++;
                }
            }
            
            return points;
        }
        
        // Función para verificar si un punto está dentro del corazón
        function isPointInsideHeart(x, y, scale) {
            // Normalizar las coordenadas
            const nx = x / (scale * 16);
            const ny = y / (scale * 13);
            
            // Usar la ecuación implícita del corazón
            // ((x²+y²-1)³) - x²y³ ≤ 0
            const term1 = Math.pow(nx * nx + ny * ny - 1, 3);
            const term2 = nx * nx * Math.pow(ny, 3);
            
            return (term1 - term2) <= 0.05; // Tolerancia para incluir más puntos
        }
        
        function createFormedHeartDisparos(x, y, index) {
            const formationArea = document.getElementById('disparosHeartFormation');
            if (!formationArea) return;
            
            const heart = document.createElement('div');
            heart.className = 'disparos-formed-heart';
            heart.textContent = ['💖', '💕', '💗', '💓', '💝'][index % 5];
            heart.style.left = x + 'px';
            heart.style.top = y + 'px';
            heart.style.animation = `disparosHeartFormation 1.2s ease-out forwards, disparosHeartPulse 2.5s ease-in-out infinite ${index * 0.05}s`;
            
            formationArea.appendChild(heart);
            disparosData.heartFormation.push(heart);
        }
        
        function updateDisparosUI() {
            const heartsFiredEl = document.getElementById('heartsFired');
            const heartsInFormationEl = document.getElementById('heartsInFormation');
            const timeEl = document.getElementById('disparosTime');
            
            if (heartsFiredEl) heartsFiredEl.textContent = disparosData.heartsFired;
            if (heartsInFormationEl) heartsInFormationEl.textContent = disparosData.heartsInFormation;
            if (timeEl) timeEl.textContent = formatTime(disparosData.time);
        }
        
        function updateDisparosMessage(message) {
            const messageEl = document.getElementById('disparosMessage');
            if (messageEl) {
                messageEl.textContent = message;
                messageEl.style.animation = 'none';
                messageEl.offsetHeight; // Trigger reflow
                messageEl.style.animation = 'fadeIn 0.5s ease-in-out';
            }
        }
        
        function startBubuHeartAnimation() {
            heartAnimationData.isActive = true;
            
            // Crear corazones flotantes cada cierto tiempo
            heartAnimationData.heartInterval = setInterval(() => {
                if (heartAnimationData.isActive) {
                    createFloatingHeart();
                }
            }, 800);
            
            // Empezar a formar el corazón grande después de 3 segundos
            setTimeout(() => {
                startHeartFormation();
            }, 3000);
        }
        
        function createFloatingHeart() {
            const heartsArea = document.getElementById('heartsArea');
            if (!heartsArea) return;
            
            const heart = document.createElement('div');
            heart.className = 'floating-heart';
            heart.textContent = ['💖', '💕', '💗', '💓', '💝'][Math.floor(Math.random() * 5)];
            
            // Posición inicial cerca del centro-inferior (donde está Bubu)
            const startX = window.innerWidth / 2 + (Math.random() - 0.5) * 100;
            const startY = window.innerHeight - 150;
            
            heart.style.left = startX + 'px';
            heart.style.top = startY + 'px';
            
            heartsArea.appendChild(heart);
            
            // Remover el corazón después de la animación
            setTimeout(() => {
                if (heart.parentNode) {
                    heart.parentNode.removeChild(heart);
                }
            }, 4000);
        }
        
        function startHeartFormation() {
            const heartFormation = document.getElementById('heartFormation');
            if (!heartFormation || heartAnimationData.formationComplete) return;
            
            // Coordenadas para formar un corazón (corazón matemático)
            const heartPoints = generateHeartPoints();
            let currentPointIndex = 0;
            
            const formationInterval = setInterval(() => {
                if (currentPointIndex >= heartPoints.length) {
                    clearInterval(formationInterval);
                    heartAnimationData.formationComplete = true;
                    return;
                }
                
                const point = heartPoints[currentPointIndex];
                createFormedHeart(point.x, point.y, currentPointIndex);
                currentPointIndex++;
            }, 200);
        }
        
        function generateHeartPoints() {
            const points = [];
            const centerX = 100;
            const centerY = 100;
            const scale = 60;
            
            // Generar puntos de un corazón usando ecuación paramétrica
            for (let t = 0; t < Math.PI * 2; t += 0.3) {
                const x = scale * (16 * Math.pow(Math.sin(t), 3));
                const y = scale * (13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t));
                
                points.push({
                    x: centerX + x / 16,
                    y: centerY - y / 16 + 20
                });
            }
            
            return points;
        }
        
        function createFormedHeart(x, y, index) {
            const heartFormation = document.getElementById('heartFormation');
            if (!heartFormation) return;
            
            const heart = document.createElement('div');
            heart.className = 'formed-heart';
            heart.textContent = ['💖', '💕', '💗', '💓', '💝'][index % 5];
            heart.style.left = x + 'px';
            heart.style.top = y + 'px';
            heart.style.animation = `heartFormation 1s ease-out forwards, heartPulse 2s ease-in-out infinite ${index * 0.1}s`;
            
            heartFormation.appendChild(heart);
            
            // Agregar a la formación
            heartAnimationData.heartFormation.push(heart);
        }
        
        // Función para reiniciar la animación
        function resetHeartAnimation() {
            heartAnimationData.formationComplete = false;
            
            // Limpiar corazones formados
            const heartFormation = document.getElementById('heartFormation');
            if (heartFormation) {
                heartFormation.innerHTML = '';
            }
            
            heartAnimationData.heartFormation = [];
            
            // Reiniciar la formación después de un momento
            setTimeout(() => {
                startHeartFormation();
            }, 2000);
        }
        
        // Reiniciar animación cada 30 segundos para mantenerla fresca
        setInterval(() => {
            if (heartAnimationData.formationComplete) {
                resetHeartAnimation();
            }
        }, 30000);

        // ================================
        // FUNCIONES PARA CORAZÓN 3D (CÓDIGO ORIGINAL EXACTO)
        // ================================

        let corazon3DActive = false;

        async function initCorazon3D() {
            if (corazon3DActive) return;
            
            try {
                console.log('Iniciando Corazón 3D con código original...');
                
                // Crear el script del corazón 3D como módulo
                const corazonScript = document.createElement('script');
                corazonScript.type = 'module';
                corazonScript.textContent = `
/*!
Heart Packing 3D #1 自由回転
https://codepen.io/wakana-k/pen/LEVgzry

Asset: 3D heart model by WakanaY.K. Commercial use is not permitted.
*/
console.clear();
import * as h from "three";
import { OrbitControls as i } from "three/addons/controls/OrbitControls.js";
import { OBJLoader as p } from "three/addons/loaders/OBJLoader.js";
import { RGBELoader as e } from "three/addons/loaders/RGBELoader.js";
import "three/addons/exporters/PLYExporter.js";
import * as g from "three/addons/utils/BufferGeometryUtils.js";

{
  let t, d, n, o, l, c, m, r, u, w;
  function a() {
    const canvas = document.getElementById('corazon3d-canvas');
    if (!canvas || !t || !n) return;
    
    t.aspect = canvas.clientWidth / canvas.clientHeight;
    t.updateProjectionMatrix();
    n.setSize(canvas.clientWidth, canvas.clientHeight);
  }
  function s() {
    if (!window.corazon3DActive) return;
    requestAnimationFrame(s);
    if (o) o.update();
    if (n && d && t) n.render(d, t);
  }
  
  window.corazon3DActive = true;
  
  new e().load(
    "https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/textures/equirectangular/quarry_01_1k.hdr",
    (e) => {
      e.mapping = h.EquirectangularReflectionMapping;
      c = e;
      
      (async function () {
        m = await AmmoPhysics();
        r = new h.Vector3();
        
        // Configurar cámara para el canvas específico
        const canvas = document.getElementById('corazon3d-canvas');
        if (!canvas) return;
        
        t = new h.PerspectiveCamera(
          60, // Campo de visión más amplio para ver mejor el corazón grande
          canvas.clientWidth / canvas.clientHeight,
          0.1,
          1e3
        );
        t.position.set(0, 0, 3.5); // Alejar un poco más la cámara
        t.lookAt(0, 0, 0);
        
        // Crear escena con fondo púrpura
        d = new h.Scene();
        d.background = new h.Color(0x2d1b69); // Fondo púrpura como tu tema
        d.environment = c;
        
        // Luces
        d.add(new h.AmbientLight(16777215, 5));
        d.add(new h.HemisphereLight(16777215, 4473924, 5));
        
        // Renderer para el canvas específico
        n = new h.WebGLRenderer({
          canvas: canvas,
          antialias: true,
          preserveDrawingBuffer: true
        });
        n.setPixelRatio(window.devicePixelRatio);
        n.setSize(canvas.clientWidth, canvas.clientHeight);
        
        // Controles
        o = new i(t, canvas);
        o.target.y = 0;
        o.autoRotate = true; // Activar rotación automática para ver mejor el corazón
        o.autoRotateSpeed = 1.0; // Velocidad de rotación
        o.enableDamping = true;
        o.enablePan = false;
        o.minDistance = 1;
        o.minPolarAngle = 0;
        o.maxPolarAngle = Math.PI / 2;
        o.update();
        
        // Crear corazones
        (function () {
          const r = new h.MeshPhongMaterial({
              envMap: c,
              reflectivity: 1,
              emissive: 0,
              specular: 16777215,
              shininess: 100
            }),
            i = new h.Matrix4(),
            a = new h.Color(),
            s = ["deeppink", "lightpink"],
            e = new p();
            
          e.load(
            "https://happy358.github.io/misc/model/Heart/Heart.obj",
            function (e) {
              let t = e.children[0].geometry;
              t = t.index ? t : g.mergeVertices(t);
              t.computeVertexNormals();
              t.computeBoundingBox();
              t.computeBoundingSphere();
              
              const terrainMaterial = new h.MeshLambertMaterial({
                color: new h.Color("pink"),
                side: h.DoubleSide,
                wireframe: true
              });
              
              // Terreno (corazón invisible para colisiones)
              l = t.clone();
              l.scale(0.1, 0.1, 0.11);
              t.center();
              t.computeVertexNormals();
              t.computeBoundingBox();
              t.computeBoundingSphere();
              l.name = "terrain";
              
              w = new h.Mesh(l, terrainMaterial);
              w.visible = false;
              w.userData.physics = { mass: 0 };
              d.add(w);
              m.addMesh(w, 0);
              
              // Corazones instanciados - USAR POSICIONES ALEATORIAS ORIGINALES
              l = t.clone();
              l.scale(0.015, 0.015, 0.015);
              l.computeVertexNormals();
              l.computeBoundingBox();
              l.computeBoundingSphere();
              
              u = new h.InstancedMesh(l, r, 50);
              u.instanceMatrix.setUsage(h.DynamicDrawUsage);
              u.userData.physics = { mass: 1 };
              
              // Aquí es donde se distribuyen las instancias de los corazones - FÓRMULA DE CORAZÓN
              for (let e = 0; e < u.count; e++) {
                let t = e / u.count * Math.PI * 2; // Calculamos el ángulo (una vuelta completa)
                let x = 16 * Math.pow(Math.sin(t), 3); // Fórmula para X
                let y = 13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t); // Fórmula para Y
                let z = h.MathUtils.randFloat(-0.3, 0.3); // Profundidad aleatoria

                // Asignamos las posiciones usando las fórmulas para X y Y con separación
                i.setPosition(
                  x * 0.035 + h.MathUtils.randFloat(-0.03, 0.03), // Escala + pequeña variación
                  y * 0.035 + h.MathUtils.randFloat(-0.03, 0.03), // Escala + pequeña variación  
                  z
                );

                // Asignamos las matrices a las instancias y colores
                u.setMatrixAt(e, i);
                u.setColorAt(e, a.set(s[e % s.length]));
              }
              
              d.add(u);
              m.addMesh(u, 1);
              
              // Mostrar botón de stop
              document.getElementById('corazon3d-start').style.display = 'none';
              document.getElementById('corazon3d-stop').style.display = 'inline-block';
              
              console.log('Corazones 3D cargados correctamente');
            }
          );
        })();
        
        s();
        window.addEventListener("resize", a);
      })();
    }
  );
}

// Función AmmoPhysics (código original exacto)
async function AmmoPhysics() {
  if ("Ammo" in window == false) {
    console.error("AmmoPhysics: Couldn't find Ammo.js");
    return {
      addMesh: () => {},
      destroy: () => {}
    };
  }
  
  const g = await Ammo();
  const o = new g.btDefaultCollisionConfiguration(),
    r = new g.btCollisionDispatcher(o),
    i = new g.btDbvtBroadphase(),
    a = new g.btSequentialImpulseConstraintSolver(),
    v = new g.btDiscreteDynamicsWorld(r, i, a, o);
    
  v.setGravity(new g.btVector3(0, -9.8, 0));
  const M = new g.btTransform();
  let x = new g.btVector3(0, 0, 0);
  const V = [],
    B = new WeakMap();
    
  function n(e, t = 0) {
    var n, o, r,
      i = (function (e) {
        var t = e.parameters;
        let n;
        if ("BoxGeometry" === e.type) {
          var o = void 0 !== t.width ? t.width / 2 : 0.5,
            r = void 0 !== t.height ? t.height / 2 : 0.5,
            i = void 0 !== t.depth ? t.depth / 2 : 0.5;
          n = new g.btBoxShape(new g.btVector3(o, r, i));
        } else if ("IcosahedronGeometry" === e.type) {
          o = void 0 !== t.radius ? t.radius : 1;
          n = new g.btSphereShape(o);
        } else if ("terrain" == e.name) {
          var a = e.attributes.position.array,
            s = e.index.array,
            d = new Ammo.btTriangleMesh();
          for (let e = 0; e < s.length; e += 3) {
            var l = new Ammo.btVector3(
                a[3 * s[e]],
                a[3 * s[e] + 1],
                a[3 * s[e] + 2]
              ),
              c = new Ammo.btVector3(
                a[3 * s[e + 1]],
                a[3 * s[e + 1] + 1],
                a[3 * s[e + 1] + 2]
              ),
              m = new Ammo.btVector3(
                a[3 * s[e + 2]],
                a[3 * s[e + 2] + 1],
                a[3 * s[e + 2] + 2]
              );
            d.addTriangle(l, c, m);
          }
          n = new Ammo.btBvhTriangleMeshShape(d, true, true);
        } else {
          var u = e.getAttribute("position");
          n = new Ammo.btConvexHullShape();
          for (let e = 0; e < u.count; e++) {
            var w = u.getX(e),
              h = u.getY(e),
              p = u.getZ(e);
            n.addPoint(new Ammo.btVector3(w, h, p), true);
          }
        }
        return n.setMargin(0.055), n;
      })(e.geometry);
      
    if (null !== i) {
      if (e.isInstancedMesh) {
        var a = e, s = t, d = i, l = a.instanceMatrix.array, c = [];
        for (let e = 0; e < a.count; e++) {
          var m = 16 * e, u = new g.btTransform();
          u.setFromOpenGLMatrix(l.slice(m, 16 + m));
          var w = new g.btDefaultMotionState(u), h = new g.btVector3(0, 0, 0);
          d.calculateLocalInertia(s, h);
          var p = new g.btRigidBodyConstructionInfo(s, w, d, h), f = new g.btRigidBody(p);
          f.setRestitution(0);
          v.addRigidBody(f);
          c.push(f);
        }
        0 < s && (V.push(a), B.set(a, c));
      } else if (e.isMesh) {
        n = e.position;
        o = e.quaternion;
        r = new g.btTransform();
        r.setIdentity();
        r.setOrigin(new g.btVector3(n.x, n.y, n.z));
        r.setRotation(new g.btQuaternion(o.x, o.y, o.z, o.w));
        var b = new g.btDefaultMotionState(r), y = new g.btVector3(0, 0, 0);
        i.calculateLocalInertia(t, y);
        var T = new g.btRigidBodyConstructionInfo(t, b, i, y), A = new g.btRigidBody(T);
        A.setRestitution(0);
        v.addRigidBody(A);
        0 < t && (V.push(e), B.set(e, A));
      }
    }
  }
  
  let A = 0;
  let s = setInterval(function () {
    if (!window.corazon3DActive) return;
    
    var e = performance.now();
    if (0 < A) {
      var t = (e - A) / 1000;
      v.stepSimulation(t, 10);
      
      for (let e = 0, t = V.length; e < t; e++) {
        var n = V[e];
        if (n.isInstancedMesh) {
          var o = n.instanceMatrix.array, r = B.get(n);
          
          for (let t = 0; t < r.length; t++) {
            r[t].getMotionState().getWorldTransform(M);
            var i = M.getOrigin();
            let e;
            if (i.y() < -3) {
              // RESETEAR EXACTAMENTE COMO EN EL CÓDIGO ORIGINAL - POSICIÓN (0,0,0)
              x.setValue(0, 0, 0);
              e = M.getRotation();
              e.x(0); e.y(0); e.z(0);
              M.setIdentity();
              M.setOrigin(x);
              M.setRotation(e);
              r[t].setWorldTransform(M);
              x.setValue(0, 0, 0);
              r[t].setLinearVelocity(x);
              r[t].setAngularVelocity(x);
              r[t].clearForces();
            } else {
              e = M.getRotation();
            }
            
            // Actualizar matriz de instancia
            var a = e.x(), s = e.y(), d = e.z(), l = e.w();
            var c = a + a, m = s + s, u = d + d;
            var w = a * c, h = a * m, p = a * u;
            var f = s * m, b = s * u, y = d * u;
            var T = c * l, A = m * l, C = u * l;
            
            var R = 16 * t;
            o[R + 0] = 1 - (f + y);
            o[R + 1] = h + C;
            o[R + 2] = p - A;
            o[R + 3] = 0;
            o[R + 4] = h - C;
            o[R + 5] = 1 - (w + y);
            o[R + 6] = b + T;
            o[R + 7] = 0;
            o[R + 8] = p + A;
            o[R + 9] = b - T;
            o[R + 10] = 1 - (w + f);
            o[R + 11] = 0;
            o[R + 12] = i.x();
            o[R + 13] = i.y();
            o[R + 14] = i.z();
            o[R + 15] = 1;
          }
          n.instanceMatrix.needsUpdate = true;
          n.computeBoundingSphere();
        } else if (n.isMesh) {
          B.get(n).getMotionState().getWorldTransform(M);
          var S = M.getOrigin(), E = M.getRotation();
          n.position.set(S.x(), S.y(), S.z());
          n.quaternion.set(E.x(), E.y(), E.z(), E.w());
        }
      }
    }
    A = e;
  }, 1000 / 60);
  
  return {
    addScene: function (e) {
      e.traverse(function (e) {
        var t;
        e.isMesh && (t = e.userData.physics) && n(e, t.mass);
      });
    },
    addMesh: n,
    setMeshPosition: function (e, t, n = 0) {
      if (e.isInstancedMesh) {
        n = B.get(e)[n];
        n.setAngularVelocity(new g.btVector3(0, 0, 0));
        n.setLinearVelocity(new g.btVector3(0, 0, 0));
        M.setIdentity();
        M.setOrigin(new g.btVector3(t.x, t.y, t.z));
        n.setWorldTransform(M);
      } else if (e.isMesh) {
        n = B.get(e);
        n.setAngularVelocity(new g.btVector3(0, 0, 0));
        n.setLinearVelocity(new g.btVector3(0, 0, 0));
        M.setIdentity();
        M.setOrigin(new g.btVector3(t.x, t.y, t.z));
        n.setWorldTransform(M);
      }
    },
    destroy: function () {
      clearInterval(s);
      for (const t of V) {
        var e = B.get(t);
        if (Array.isArray(e)) {
          for (const n of e) {
            v.removeRigidBody(n);
            g.destroy(n);
          }
        } else {
          v.removeRigidBody(e);
          g.destroy(e);
        }
        B.delete(t);
      }
      V.length = 0;
      g.destroy(v);
      g.destroy(a);
      g.destroy(i);
      g.destroy(r);
      g.destroy(o);
      g.destroy(x);
      g.destroy(M);
    }
  };
}
                `;
                
                // Agregar el script al documento
                document.head.appendChild(corazonScript);
                
                corazon3DActive = true;
                
            } catch (error) {
                console.error('Error al cargar Corazón 3D:', error);
                alert('Error: ' + error.message);
            }
        }

        function stopCorazon3D() {
            console.log('Deteniendo Corazón 3D...');
            
            window.corazon3DActive = false;
            corazon3DActive = false;
            
            // Limpiar canvas
            const canvas = document.getElementById('corazon3d-canvas');
            if (canvas) {
                const context = canvas.getContext('webgl') || canvas.getContext('webgl2');
                if (context) {
                    context.clear(context.COLOR_BUFFER_BIT | context.DEPTH_BUFFER_BIT);
                }
            }
            
            // Mostrar botón de start
            document.getElementById('corazon3d-start').style.display = 'inline-block';
            document.getElementById('corazon3d-stop').style.display = 'none';
            
            // Recargar página para limpiar completamente
            setTimeout(() => {
                location.reload();
            }, 1000);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const startBtn = document.getElementById('corazon3d-start');
            const stopBtn = document.getElementById('corazon3d-stop');

            if (startBtn) {
                startBtn.addEventListener('click', initCorazon3D);
            }

            if (stopBtn) {
                stopBtn.addEventListener('click', stopCorazon3D);
            }
        });

        // ================================
        // FUNCIONES PARA CORAZÓN DE PARTÍCULAS
        // ================================

        // Configuration
        const particlesConfig = {
            particleCount: 32,
            speed: 1,
            colorScheme: 'rainbow',
            mouseInfluence: 50,
            showHeartOutline: true,
            particleSize: 10
        };

        // Canvas setup
        let particlesCanvas = null;
        let particlesCtx = null;
        let particlesCanvasWidth = 0;
        let particlesCanvasHeight = 0;

        // Animation state
        let particlesTrails = [];
        let particlesHeartPath = [];
        let particlesMouseX = 0;
        let particlesMouseY = 0;
        let particlesMouseActive = false;
        let particlesAnimationRunning = false;
        let particlesAnimationId = null;

        // Initialize heart path points (fixed formula)
        function initParticlesHeartPath() {
            particlesHeartPath = [];
            const PI2 = 6.28318; // 2*PI approximation
            const steps = Math.max(32, particlesConfig.particleCount);
            
            for (let i = 0; i < steps; i++) {
                const t = (i / steps) * PI2;
                particlesHeartPath.push([
                    particlesCanvasWidth/2 + 180 * Math.pow(Math.sin(t), 3),
                    particlesCanvasHeight/2 + 10 * (-(15 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t)))
                ]);
            }
        }

        // Initialize particles with proper bounds checking
        function initParticlesSystem() {
            particlesTrails = [];
            if (particlesHeartPath.length === 0) initParticlesHeartPath();

            for (let i = 0; i < particlesConfig.particleCount; i++) {
                const particles = [];
                const x = Math.random() * particlesCanvasWidth;
                const y = Math.random() * particlesCanvasHeight;

                for (let k = 0; k < particlesConfig.particleCount; k++) {
                    // Color generation
                    let hue, saturation = Math.random() * 40 + 60;
                    let brightness = Math.random() * 60 + 20;
                    
                    switch(particlesConfig.colorScheme) {
                        case 'red': hue = Math.random() * 20 + 350; break;
                        case 'blue': hue = Math.random() * 20 + 200; break;
                        case 'green': hue = Math.random() * 20 + 100; break;
                        case 'monochrome': hue = 0; saturation = 0; break;
                        default: hue = i/particlesConfig.particleCount * 360; // rainbow
                    }

                    particles.push({
                        x, y,
                        velX: 0, velY: 0,
                        radius: ((1 - k/particlesConfig.particleCount) + 1) * particlesConfig.particleSize/2,
                        speed: Math.random() + 1,
                        targetIndex: Math.floor(Math.random() * particlesHeartPath.length),
                        direction: i % 2 * 2 - 1,
                        friction: Math.random() * 0.2 + 0.7,
                        color: `hsla(${hue},${saturation}%,${brightness}%,0.1)`
                    });
                }
                particlesTrails.push(particles);
            }
        }

        // Render a single particle
        function renderParticle(particle) {
            particlesCtx.fillStyle = particle.color;
            particlesCtx.beginPath();
            particlesCtx.arc(particle.x, particle.y, particle.radius, 0, Math.PI * 2);
            particlesCtx.fill();
        }

        // Main animation loop with robust error handling
        function particlesAnimationLoop() {
            if (!particlesAnimationRunning) return;

            try {
                // Clear with trail effect
                particlesCtx.fillStyle = "rgba(0, 0, 0, 0.2)";
                particlesCtx.fillRect(0, 0, particlesCanvasWidth, particlesCanvasHeight);

                particlesTrails.forEach(trail => {
                    if (!trail || !trail.length) return;
                    
                    const leader = trail[0];
                    const target = particlesHeartPath[leader.targetIndex % particlesHeartPath.length];
                    if (!target) return;

                    // Mouse influence
                    if (particlesMouseActive && particlesConfig.mouseInfluence > 0) {
                        const dx = particlesMouseX - leader.x;
                        const dy = particlesMouseY - leader.y;
                        const dist = Math.sqrt(dx*dx + dy*dy);
                        
                        if (dist < 300) {
                            const force = (1 - dist/300) * (particlesConfig.mouseInfluence/20);
                            leader.velX += dx/dist * force;
                            leader.velY += dy/dist * force;
                        }
                    }

                    // Move toward target
                    const dx = leader.x - target[0];
                    const dy = leader.y - target[1];
                    const dist = Math.sqrt(dx*dx + dy*dy);

                    if (dist < 10) {
                        if (Math.random() > 0.95) {
                            leader.targetIndex = Math.floor(Math.random() * particlesHeartPath.length);
                        } else {
                            if (Math.random() > 0.99) leader.direction *= -1;
                            leader.targetIndex += leader.direction;
                            leader.targetIndex = (leader.targetIndex + particlesHeartPath.length) % particlesHeartPath.length;
                        }
                    }

                    // Update physics
                    leader.velX += -dx/dist * leader.speed * particlesConfig.speed;
                    leader.velY += -dy/dist * leader.speed * particlesConfig.speed;
                    leader.x += leader.velX;
                    leader.y += leader.velY;
                    leader.velX *= leader.friction;
                    leader.velY *= leader.friction;

                    // Render trail
                    renderParticle(leader);
                    for (let k = 1; k < trail.length; k++) {
                        trail[k].x -= (trail[k].x - trail[k-1].x) * 0.7;
                        trail[k].y -= (trail[k].y - trail[k-1].y) * 0.7;
                        renderParticle(trail[k]);
                    }
                });
            } catch (error) {
                console.error("Particles animation error:", error);
            }

            particlesAnimationId = requestAnimationFrame(particlesAnimationLoop);
        }

        // Control handlers
        function setupParticlesControls() {
            const controls = document.getElementById('corazon-particulas-controls');
            let controlsVisible = true;

            const toggleControlsBtn = document.getElementById('corazon-particulas-toggle-controls');
            if (toggleControlsBtn) {
                toggleControlsBtn.addEventListener('click', () => {
                    controlsVisible = !controlsVisible;
                    controls.style.display = controlsVisible ? 'block' : 'none';
                });
            }

            const toggleFullscreenBtn = document.getElementById('corazon-particulas-toggle-fullscreen');
            if (toggleFullscreenBtn) {
                toggleFullscreenBtn.addEventListener('click', () => {
                    if (!document.fullscreenElement) {
                        particlesCanvas.requestFullscreen();
                    } else {
                        if (document.exitFullscreen) {
                            document.exitFullscreen();
                        }
                    }
                });
            }

            const updateParticles = () => {
                particlesConfig.particleCount = Math.min(100, Math.max(10, 
                    parseInt(document.getElementById('corazon-particulas-particleCount').value)));
                document.getElementById('corazon-particulas-particleCountValue').textContent = particlesConfig.particleCount;
                initParticlesHeartPath();
                initParticlesSystem();
            };

            const particleCountSlider = document.getElementById('corazon-particulas-particleCount');
            if (particleCountSlider) {
                particleCountSlider.addEventListener('input', updateParticles);
            }

            const speedSlider = document.getElementById('corazon-particulas-speed');
            if (speedSlider) {
                speedSlider.addEventListener('input', (e) => {
                    particlesConfig.speed = parseFloat(e.target.value);
                    document.getElementById('corazon-particulas-speedValue').textContent = particlesConfig.speed;
                });
            }

            const colorSchemeSelect = document.getElementById('corazon-particulas-colorScheme');
            if (colorSchemeSelect) {
                colorSchemeSelect.addEventListener('change', (e) => {
                    particlesConfig.colorScheme = e.target.value;
                    initParticlesSystem();
                });
            }

            const mouseInfluenceSlider = document.getElementById('corazon-particulas-mouseInfluence');
            if (mouseInfluenceSlider) {
                mouseInfluenceSlider.addEventListener('input', (e) => {
                    particlesConfig.mouseInfluence = parseInt(e.target.value);
                    document.getElementById('corazon-particulas-mouseInfluenceValue').textContent = particlesConfig.mouseInfluence;
                });
            }

            const particleSizeSlider = document.getElementById('corazon-particulas-particleSize');
            if (particleSizeSlider) {
                particleSizeSlider.addEventListener('input', (e) => {
                    particlesConfig.particleSize = parseInt(e.target.value);
                    document.getElementById('corazon-particulas-particleSizeValue').textContent = particlesConfig.particleSize;
                    initParticlesSystem();
                });
            }

            // Mouse tracking específico para el canvas de partículas
            if (particlesCanvas) {
                particlesCanvas.addEventListener('mousemove', (e) => {
                    const rect = particlesCanvas.getBoundingClientRect();
                    particlesMouseX = (e.clientX - rect.left) * (particlesCanvasWidth / rect.width);
                    particlesMouseY = (e.clientY - rect.top) * (particlesCanvasHeight / rect.height);
                    particlesMouseActive = true;
                });
                
                particlesCanvas.addEventListener('mouseleave', () => {
                    particlesMouseActive = false;
                });
            }

            // Window resize
            window.addEventListener('resize', () => {
                if (particlesCanvas && particlesAnimationRunning) {
                    const container = document.querySelector('.corazon-particulas-container');
                    if (container) {
                        particlesCanvasWidth = particlesCanvas.width = container.clientWidth;
                        particlesCanvasHeight = particlesCanvas.height = container.clientHeight;
                        initParticlesHeartPath();
                    }
                }
            });
        }

        // Initialize particles system
        function initParticlesHeart() {
            if (particlesAnimationRunning) return;

            try {
                console.log('Iniciando Corazón de Partículas...');

                particlesCanvas = document.getElementById('corazon-particulas-canvas');
                if (!particlesCanvas) {
                    console.error('Canvas de partículas no encontrado');
                    return;
                }

                particlesCtx = particlesCanvas.getContext('2d');
                const container = document.querySelector('.corazon-particulas-container');
                
                particlesCanvasWidth = particlesCanvas.width = container.clientWidth;
                particlesCanvasHeight = particlesCanvas.height = container.clientHeight;

                particlesMouseX = particlesCanvasWidth / 2;
                particlesMouseY = particlesCanvasHeight / 2;

                particlesAnimationRunning = true;
                setupParticlesControls();
                
                // Initialize everything
                initParticlesHeartPath();
                initParticlesSystem();
                particlesAnimationLoop();

                // Mostrar botón de stop
                document.getElementById('corazon-particulas-start').style.display = 'none';
                document.getElementById('corazon-particulas-stop').style.display = 'inline-block';

                console.log('Corazón de Partículas iniciado correctamente');

            } catch (error) {
                console.error('Error al iniciar Corazón de Partículas:', error);
                alert('Error al cargar Corazón de Partículas: ' + error.message);
            }
        }

        // Stop particles system
        function stopParticlesHeart() {
            console.log('Deteniendo Corazón de Partículas...');
            
            particlesAnimationRunning = false;
            
            if (particlesAnimationId) {
                cancelAnimationFrame(particlesAnimationId);
                particlesAnimationId = null;
            }

            // Limpiar canvas
            if (particlesCtx && particlesCanvas) {
                particlesCtx.clearRect(0, 0, particlesCanvasWidth, particlesCanvasHeight);
            }

            // Reset variables
            particlesTrails = [];
            particlesHeartPath = [];
            particlesMouseActive = false;

            // Mostrar botón de start
            document.getElementById('corazon-particulas-start').style.display = 'inline-block';
            document.getElementById('corazon-particulas-stop').style.display = 'none';

            console.log('Corazón de Partículas detenido');
        }

        // Event listeners para partículas
        document.addEventListener('DOMContentLoaded', function() {
            const particlesStartBtn = document.getElementById('corazon-particulas-start');
            const particlesStopBtn = document.getElementById('corazon-particulas-stop');

            if (particlesStartBtn) {
                particlesStartBtn.addEventListener('click', function() {
                    console.log('Botón Iniciar Partículas presionado');
                    initParticlesHeart();
                });
            }

            if (particlesStopBtn) {
                particlesStopBtn.addEventListener('click', function() {
                    console.log('Botón Detener Partículas presionado');
                    stopParticlesHeart();
                });
            }

            console.log('Event listeners para Corazón de Partículas configurados');
        });
    </script>
</body>
</html>
